#include "ada_print.h"
#include "HttpClient.h"
/*#include "ArduinoJson.h"*/
#include <vector>

Adafruit_Thermal printer(&Serial1);

HttpClient http;
http_request_t request;
http_response_t response;
http_header_t headers[] = {
    //  { "Content-Type", "application/json" },
    //  { "Accept" , "application/json" },
    { "Accept" , "*/*"},
    { NULL, NULL } // NOTE: Always terminate headers will NULL
};

void setup() {
  Serial1.begin(19200);

  printer.begin();
  printer.underlineOn();
  printer.println(F("Print Server Opened"));
  printer.underlineOff();
  printer.feed(2);
  printer.setDefault();

  std::vector<uint8_t> v {72,101,108,108,111,44,32,97,110,100,32,27,33,8,119,101,108,99,111,109,101,27,33,0,32,116,111,32,116,104,105,115,10,10,27,33,56,27,45,1,72,101,114,101,39,115,32,97,32,104,101,97,100,101,114,27,45,0,27,33,0,10,10,97,98,99,100,101,102,103,32,119,105,116,104,32,29,66,1,99,111,100,101,32,50,32,43,32,50,29,66,0,32,97,110,100,32,115,117,99,104,32,97,110,100,32,115,111,32,111,110,32,97,110,100,32,115,111,32,102,111,114,116,104,32,97,110,100,32,115,111,32,111,110,32,97,110,100,32,115,111,32,102,111,114,116,104,10,10,27,33,56,27,45,1,87,111,119,32,77,111,114,101,32,72,101,97,100,101,114,115,27,45,0,27,33,0,10,10,91,104,101,114,101,93,40,103,111,111,103,108,101,46,99,111,109,41,32,105,115,32,97,32,108,105,110,107,32,97,110,100,32,115,111,32,111,110,32,97,110,100,32,115,111,32,102,111,114,116,104,32,97,110,100,32,115,111,32,111,110,32,97,110,100,32,115,111,32,102,111,114,116,104,10,10,27,33,56,27,45,1,73,32,110,101,101,100,32,115,108,101,101,112,27,45,0,27,33,0,10,10,27,66,2,104,101,114,101,32,105,115,32,97,32,113,117,111,116,101,32,97,32,113,117,111,116,101,32,97,32,113,117,111,116,101,32,97,32,113,117,111,116,101,32,97,32,113,117,111,116,101,10,27,66,0,104,101,114,101,32,105,115,32,97,32,108,105,115,116,58,10,27,66,2,45,97,10,45,98,10,45,99,10,27,66,0,10,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,45,10};
  for( int i = 0; i < v.size(); i++ )
   printer.writeBytes(v[i]);

  Particle.function("notify", notify);
}

void loop() {
}

int notify(String resource) {
    request.hostname = "api.myjson.com";
    request.port = 80;
    request.path = "/bins/" + resource;

    http.get(request, response, headers);

    if (response.status == 200) {
      printer.println(response.body);
      printer.feed(2);
    }

    return response.status;
}
